{% extends 'base.html' %}
{% load i18n %}
{% load static %}
{% load humanize %}

{% block content %}
{% include 'breadcrumbs.html' with title=_("Passkey list") %}
<div class="row justify-content-center">
  <div class="col">
    <div class="row row-cols-1 g-2">
      <div class="col">
        <button
          type="button"
          class="btn btn-primary w-100 custom-boxshadow"
          data-bs-toggle="modal"
          data-bs-target="#add-passkey-modal"
        >
          {% trans "Add a new passkey" %}
        </button>
      </div>
      {% if passkeys %}
      <div class="col">
        <div class="table-responsive">
          <table class="table">
            <thead>
              <tr class="align-middle">
                <th scope="col" class="text-nowrap">{% trans "Name" %}</th>
                <th scope="col" class="text-nowrap">{% trans "Created at" %}</th>
                <th scope="col" class="text-nowrap">{% trans "Platform" %}</th>
                <th scope="col" class="text-nowrap">{% trans "Last Used" %}</th>
                <th colspan="2" class="text-nowrap">{% trans "Operation" %}</th>
              </tr>
            </thead>
            <tbody class="table-group-divider">
            {% for instance in passkeys %}
              <tr class="align-middle">
                {% with table_css=instance.is_enabled|yesno:',table-secondary' %}
                <td scope="row" class="{{ table_css }}">{{ instance.name }}</td>
                <td class="{{ table_css }}">{{ instance.created_at|naturaltime }}</td>
                <td class="{{ table_css }}">{{ instance.platform }}</td>
                <td class="{{ table_css }}">{% if instance.last_used %}{{ instance.last_used|naturaltime }}{% else %}-{% endif %}</td>
                {% endwith %}
                <td>
                  <form
                    class="js-update-passkey-form"
                    action="{% url 'passkey:update_passkey' pk=instance.pk %}"
                    method="POST"
                  >
                    {% csrf_token %}
                    <button type="submit" class="btn btn-outline-{{ instance.is_enabled|yesno:'danger,primary' }} w-100 custom-boxshadow text-nowrap">
                      {% if instance.is_enabled %}{% trans "Disabled" %}{% else %}{% trans "Enabled" %}{% endif %}
                    </button>
                  </form>
                </td>
                <td>
                  {% if instance.is_enabled %}
                  <button
                    type="button"
                    class="btn btn-outline-danger w-100 custom-boxshadow text-nowrap"
                    data-name="{{ instance.name }}"
                    data-url="#"
                    disabled
                  >
                    {% trans "Delete" %}
                  </button>
                  {% else %}
                  <button
                    type="button"
                    class="btn btn-outline-danger w-100 custom-boxshadow text-nowrap js-delete-passkey"
                    data-name="{{ instance.name }}"
                    data-url="{% url 'passkey:delete_passkey' pk=instance.pk %}"
                  >
                    {% trans "Delete" %}
                  </button>
                  {% endif %}
                </td>
              </tr>
            {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
      <div class="col">
      {% include "renderer/custom_pagenate.html" with page_obj=page_obj %}
      </div>
      {% else %}
      <div class="col">
        <p>{% trans "There is no passkey." %}</p>
      </div>
      {% endif %}
    </div>
  </div>
</div>

{# Add a new passkey modal #}
<div class="modal" id="add-passkey-modal" tabindex="-1" aria-labelledby="add-passkey-label" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <p class="modal-title fs-5" id="add-passkey-label">{% trans "Add a new passkey" %}</p>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        {% csrf_token %}
        <p>{% trans "Enter a new token name" %}</p>
        <div>
          <input
            type="text"
            id="key-name"
            class="form-control"
            placeholder="{% trans 'Laptop, PC, mobile, etc.' %}"
          />
        </div>
        <div id="result-for-registration" class="mt-2"></div>
      </div>
      <div class="modal-footer">
        <div class="row g-2 w-100">
          <div class="col-12 col-md-6">
            <button type="button" id="register-passkey" class="btn btn-primary w-100 custom-boxshadow">
              {% trans "Add" %}
            </button>
          </div>
          <div class="col-12 col-md-6">
            <button type="button" class="btn btn-secondary w-100 custom-boxshadow" data-bs-dismiss="modal">
              {% trans "Close" %}
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{# Delete modal #}
{% include "delete_modal_form.html" with modal_id="delete-modal" form_id="delete-form" %}
{% endblock %}

{% block bodyjs %}
{{ block.super }}
<script type="application/javascript" src="{% static 'js/passkey-helpers.js' %}"></script>
<script>
(function () {
  const init = () => {
    const helper = new HelperMethods();
    // Add delete modal event
    helper.registerDeleteModalEvent({
      btnClass: 'js-delete-passkey',
      formID: 'delete-form',
      modalID: 'delete-modal',
    });
    //
    // Add events with relevant to passkey
    //
    const registerNewPasskeyBtn = document.querySelector('#register-passkey');
    const inputKey = document.querySelector('#key-name');
    // Add short-cut event
    inputKey.addEventListener('keyup', (event) => {
      if (event.key === 'Enter') {
        registerNewPasskeyBtn.click();
      }
    }, false);
    // Add a new passkey event
    registerNewPasskeyBtn.addEventListener('click', () => {
      const registerURL = '{% url "passkey:register_passkey" %}';
      const completeURL = '{% url "passkey:complete_passkey_registration" %}';
      const keyName = inputKey.value;
      const csrftoken = document.querySelector('[name="csrfmiddlewaretoken"]').value;
      const callback = (status_code, message) => {
        const createResultNode = (text, msgType) => {
          const node = document.createElement('div');
          node.textContent = text;
          node.classList.add('alert', msgType);

          return node;
        };
        const result = document.querySelector('#result-for-registration');
        // Remove old elements
        while (result.firstChild) {
          result.removeChild(result.firstChild);
        }
        // Update result node
        if (status_code === 200) {
          const text = '{% trans "Registered successfully. After 3 seconds, refresh the page." %}';
          const node = createResultNode(text, 'alert-success');
          result.appendChild(node);
          setTimeout(() => {
            window.location.href = '{% url "passkey:passkey_list" %}';
          }, 3000);
        }
        else {
          const node = createResultNode(message, 'alert-danger');
          result.appendChild(node);
        }
      };
      // Call registration function
      Passkey.RegisterPasskey(registerURL, completeURL, keyName, csrftoken, callback);
    });
    // Initialize passkey library
    Passkey.Init();
  };
  // Add DOM event
  document.addEventListener('DOMContentLoaded', init);
})();
</script>
{% endblock %}