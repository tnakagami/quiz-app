map $http_x_forwarded_port $proxy_x_forwarded_port {
  default $http_x_forwarded_port;
  ''      $server_port;
}

server {
    listen       80;
    <% if ENV['LISTEN_IPV6'] && ENV['LISTEN_IPV6'].downcase == 'true' %>
    listen       [::]:80;
    <% end %>
    server_name  <%= domain.name %>;
    charset utf-8;

    location /static/ {
      alias /etc/nginx/static/;
    }
    location / {
      proxy_pass http://django:8001;
      # Mitigate httpoxy attack (see README for details)
      proxy_set_header Proxy "";
      proxy_redirect off;
      proxy_set_header Host              $host;
      proxy_set_header X-Forwarded-Host  $server_name;
      proxy_set_header X-Real-IP         $remote_addr;
      proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_set_header X-Forwarded-Port  $proxy_x_forwarded_port;
    }

    <%= acme_challenge_location %>

    <% if ENV['CUSTOM_NGINX_SERVER_PLAIN_CONFIG_BLOCK'] %>
      <%= ENV['CUSTOM_NGINX_SERVER_PLAIN_CONFIG_BLOCK'] %>
    <% end %>

}